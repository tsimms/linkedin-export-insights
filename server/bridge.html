
<script>
  // receive client request and send to server
  window.addEventListener('message', async (event) => {
    const { data, origin } = event;
    try {
      console.log('BRIDGE data: ' + data);
      const { action } = JSON.parse(data);
      if (action === 'fetch') {
          await doFetch(data, origin);
      } else if (action === 'bridge_proxy_response') {
          sendProxyResponse(data);
      }
    } catch (e) {
      console.log('Expecting action property in ' + data);
    }
  });

  const doFetch = async (data, origin) => {
    try {
      const { action, url, method, headers, body, timestamp } = JSON.parse(data);
      console.log({ body });
      // body is JSON
      const res = await fetch(url, { method, headers, body });
    if (res.ok) {
      // process results from server
      const results = await res.json();
      let type = 'bridge_response';
      if (JSON.parse(body).query.includes('query IntrospectionQuery')) {
        type = 'bridge_introspection';
      }
      console.log('BRIDGE: sending "' + type + '" response from successful query');
      window.parent.postMessage(JSON.stringify({ type, timestamp, results }), origin);
    } else {
        const { errors } = await res.json();
        const message = 'Error response from endpoint: ' + res.statusText;
        window.parent.postMessage(JSON.stringify({ type: 'bridge_error', message, results: errors }), origin);
      }
    } catch (e) {
      const message = 'Error sending request to endpoint';
      console.error(message);
      window.parent.postMessage(JSON.stringify({ type: 'bridge_error', message }), origin);
    }
  }

  const sendProxyResponse = (data) => {
    const { body } = JSON.parse(data);
    ws.send(body);
  }

  const ws = new WebSocket('ws://%hostname%');
  ws.onopen = () => { console.log('WebSocket connection established.'); };
  ws.onclose = () => { console.log('WebSocket connection closed.'); };
  ws.onerror = (error) => { console.error('WebSocket error:', error); };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log('Received a proxy fetch message for ' + data.url);
    if (data.action === 'fetch') {
      const { url } = data;
      window.parent.postMessage(JSON.stringify({ type: 'bridge_proxy_request', url }), origin)
    }
  }
</script>
